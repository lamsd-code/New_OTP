<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
    <title layout:fragment="pageTitle">Danh s√°ch t√≤a nh√† | SkyLand</title>

    <!-- ‚úÖ Font Awesome b·∫£n ·ªïn ƒë·ªãnh -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-pYdK1vCD7WfsPge2uP2GngQ6ZYoRC+O4uHeVkFJj5Yz5fAg97yJlHSlOkYamHQtbfsOgRWeQDBkW8aOGwUuFg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
</head>

<body>
<main layout:fragment="content" class="container py-5">

    <!-- üè¢ Ti√™u ƒë·ªÅ + n√∫t th√™m -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Danh s√°ch t√≤a nh√†</h2>
        <!-- ‚úÖ Th√¥ng b√°o d√†nh ri√™ng cho STAFF -->
		<div sec:authorize="hasAuthority('STAFF')" class="alert alert-info mt-2">
		    <i class="fa-solid fa-building-user me-2"></i>
		    Danh s√°ch t√≤a nh√† b·∫°n ƒë∆∞·ª£c giao
		</div>
        
        <!-- ‚úÖ Ch·ªâ MANAGER v√† ADMIN ƒë∆∞·ª£c th√™m -->
        <a th:href="@{/admin/building-edit}"
           class="btn btn-primary"
           sec:authorize="hasAnyAuthority('MANAGER','ADMIN')">
            <i class="fa-solid fa-plus me-2"></i>Th√™m t√≤a nh√†
        </a>
    </div>

    <!-- üîç Form t√¨m ki·∫øm -->
    <form th:action="@{/admin/building-list}" method="get"
          class="card card-body mb-4 shadow-sm" th:object="${modelSearch}">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label fw-bold">T√™n t√≤a nh√†</label>
                <input th:field="*{name}" class="form-control" placeholder="VD: Sky Tower"/>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Ph∆∞·ªùng</label>
                <input th:field="*{ward}" class="form-control" placeholder="Ph∆∞·ªùng..."/>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">ƒê∆∞·ªùng</label>
                <input th:field="*{street}" class="form-control" placeholder="ƒê∆∞·ªùng..."/>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">T√™n qu·∫£n l√Ω</label>
                <input th:field="*{managerName}" class="form-control" placeholder="Nguy·ªÖn VƒÉn A"/>
            </div>
        </div>

        <div class="row g-3 mt-3">
            <div class="col-md-3">
                <label class="form-label fw-bold">ƒêi·ªán tho·∫°i qu·∫£n l√Ω</label>
                <input th:field="*{managerPhone}" class="form-control"/>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Qu·∫≠n</label>
                <select th:field="*{district}" class="form-select">
                    <option value="">---Ch·ªçn Qu·∫≠n---</option>
                    <option th:each="district : ${districts}"
                            th:value="${district.key}"
                            th:text="${district.value}"></option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Lo·∫°i t√≤a nh√†</label>
                <div th:each="type : ${typeCodes}" class="form-check">
                    <input type="checkbox" th:field="*{typeCode}" th:value="${type.key}" class="form-check-input"/>
                    <label th:text="${type.value}" class="form-check-label"></label>
                </div>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">
                    <i class="fa-solid fa-magnifying-glass me-2"></i>T√¨m ki·∫øm
                </button>
            </div>
        </div>
    </form>

    <!-- üìã B·∫£ng danh s√°ch -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle shadow-sm">
            <thead class="table-success text-center">
            <tr>
                <th>#</th>
                <th>T√™n t√≤a nh√†</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>Qu·∫£n l√Ω</th>
                <th>ƒêi·ªán tho·∫°i</th>
                <th>Gi√° thu√™</th>
                <th>Thao t√°c</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="b, iterStat : ${buildingList}">
                <td th:text="${iterStat.count}">1</td>
                <td th:text="${b.name}">Sky Tower</td>
                <td th:text="${b.address}">123 Nguy·ªÖn Hu·ªá</td>
                <td th:text="${b.managerName}">Nguy·ªÖn VƒÉn A</td>
                <td th:text="${b.managerPhone}">0909123456</td>
                <td th:text="${b.rentPrice}">25 tri·ªáu</td>
                <td class="text-center">
                    <!-- ‚úèÔ∏è S·ª≠a -->
                    <a th:href="@{'/admin/building-edit-' + ${b.id}}"
                       class="btn btn-sm btn-warning text-white me-1"
                       sec:authorize="hasAnyAuthority('MANAGER','ADMIN')">
                        <i class="fa-solid fa-pen me-1"></i>S·ª≠a
                    </a>

                    <!-- üë• Giao nh√¢n vi√™n -->
                    <button type="button"
                            class="btn btn-sm btn-info text-white me-1"
                            th:attr="data-id=${b.id}"
                            onclick="assignBuilding(this)"
                            sec:authorize="hasAnyAuthority('MANAGER','ADMIN')">
                        <i class="fa-solid fa-user-check me-1"></i>Giao
                    </button>

                    <!-- üóëÔ∏è X√≥a -->
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            th:attr="data-id=${b.id}"
                            onclick="confirmDelete(this)"
                            sec:authorize="hasAnyAuthority('MANAGER','ADMIN')">
                        <i class="fa-solid fa-trash me-1"></i>X√≥a
                    </button>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(buildingList)}">
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fa-solid fa-box-open me-2"></i>Kh√¥ng c√≥ t√≤a nh√† n√†o
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <!-- Modal giao nh√¢n vi√™n -->
	<div class="modal fade" id="assignModal" tabindex="-1">
	  <div class="modal-dialog modal-dialog-centered modal-lg">
	    <div class="modal-content">
	      <div class="modal-header bg-success text-white">
	        <h5 class="modal-title fw-bold">Giao nh√¢n vi√™n cho t√≤a nh√†</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	      </div>
	      <div class="modal-body">
	        <input type="hidden" id="assignBuildingId"/>
	        <table class="table table-bordered align-middle text-center">
	          <thead class="table-light">
	            <tr>
	              <th>Ch·ªçn</th>
	              <th>H·ªç t√™n</th>
	              <th>T√™n ƒëƒÉng nh·∫≠p</th>
	            </tr>
	          </thead>
	          <tbody id="staffTableBody">
	            <!-- Nh√¢n vi√™n s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
	          </tbody>
	        </table>
	      </div>
	      <div class="modal-footer">
	        <button type="button" id="btnSaveAssign" class="btn btn-success">
	          <i class="fa-solid fa-check me-1"></i> L∆∞u ph√¢n c√¥ng
	        </button>
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
	      </div>
	    </div>
	  </div>
	</div>
    
</main>

<!-- ‚úÖ Scripts ri√™ng c·ªßa trang n√†y -->
<th:block layout:fragment="scripts">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:inline="javascript">
        // üóëÔ∏è X√ìA T√íA NH√Ä
        function confirmDelete(btn) {
            const id = $(btn).data('id');
            if (!id) {
                alert('Kh√¥ng t√¨m th·∫•y ID t√≤a nh√†!');
                return;
            }

            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√≤a nh√† n√†y kh√¥ng?')) {
                $.ajax({
                    url: '/api/building/' + id,
                    type: 'DELETE',
                    success: function (res) {
                        console.log('‚úÖ X√≥a th√†nh c√¥ng:', res);
                        alert('ƒê√£ x√≥a th√†nh c√¥ng!');
                        window.location.reload();
                    },
                    error: function (xhr) {
                        console.error('‚ùå L·ªói khi x√≥a:', xhr);
                        alert('X√≥a th·∫•t b·∫°i! (' + xhr.status + ')');
                    }
                });
            }
        }

        // üë• GIAO NH√ÇN VI√äN
        function assignBuilding(btn) {
		  const buildingId = $(btn).data('id');
		  $('#assignBuildingId').val(buildingId);
		
		  $.ajax({
		    url: `/api/building/${buildingId}/staffs`,
		    type: "GET",
		    success: function (res) {
		      const staffList = res.data || [];
		      let rows = "";
		
		      staffList.forEach(s => {
		        rows += `
		          <tr>
		            <td><input type="checkbox" value="${s.staffId}" ${s.checked ? 'checked' : ''}></td>
		            <td>${s.fullName ?? ''}</td>
		            <td>${s.userName ?? s.username ?? ''}</td>
		          </tr>`;
		      });
		
		      $('#staffTableBody').html(rows);
		      new bootstrap.Modal(document.getElementById('assignModal')).show();
		    },
		    error: function (xhr) {
		      alert("‚ùå L·ªói khi t·∫£i danh s√°ch nh√¢n vi√™n (" + xhr.status + ")");
		      console.log(xhr.responseText);
		    }
		  });
		}


		// üü¢ G·ª≠i ph√¢n c√¥ng khi b·∫•m ‚ÄúL∆∞u ph√¢n c√¥ng‚Äù
		$('#btnSaveAssign').click(function () {
		  const buildingId = Number($('#assignBuildingId').val());
		  const staffIds = $('#staffTableBody input[type=checkbox]:checked')
		      .map(function(){ return Number($(this).val()); })
		      .get();
		
		  const data = { id: buildingId, staffs: staffIds }; // <-- ƒë√∫ng t√™n fields
		
		  $.ajax({
		    type: "POST",
		    url: "/api/building/assignment",
		    contentType: "application/json",
		    data: JSON.stringify(data),
		    success: function () {
		      alert("‚úÖ Giao nh√¢n vi√™n th√†nh c√¥ng!");
		      window.location.reload();
		    },
		    error: function (xhr) {
		      alert("‚ùå Giao th·∫•t b·∫°i (" + xhr.status + ")");
		      console.log(xhr.responseText); // xem chi ti·∫øt l·ªói backend
		    }
		  });
		});


    </script>
</th:block>
</body>
</html>
